import { db } from "@/lib/firebase";
import { collection, getDocs, doc, setDoc, writeBatch, getDoc, addDoc } from "firebase/firestore";

export type RepairStatus = "Cotización" | "Confirmado" | "En Reparación" | "Reparado" | "Entregado";

export type FunctionalityTestResults = {
    cameraFront: "ok" | "fail" | "na";
    cameraBack: "ok" | "fail" | "na";
    chargingPort: "ok" | "fail" | "na";
    screen: "ok" | "fail" | "na";
    touch: "ok" | "fail" | "na";
    buttons: "ok" | "fail" | "na";
    earpiece: "ok" | "fail" | "na";
    speaker: "ok" | "fail" | "na";
    microphone: "ok" | "fail" | "na";
    wifi: "ok" | "fail" | "na";
    biometrics: "ok" | "fail" | "na";
    other?: string;
};


export type Repair = {
    id: string;
    customer: string;
    device: string; // This will now be the product to repair, e.g., "iPhone 14"
    technician: string;
    status: RepairStatus;
    entryDate: string; // Should be in a format that can include time, e.g., ISO string
    deviceType: 'Tablet' | 'Celular' | 'Reloj' | 'Laptop';
    problemDescription: string;
    imeiOrSn?: string;
    password?: string;
    evaluation?: string;
    functionalityTest?: FunctionalityTestResults;
};

// Omit 'id' as it will be auto-generated by Firestore
export type NewRepair = Omit<Repair, 'id' | 'status' | 'entryDate' | 'evaluation' | 'technician'> & {
    technician?: string;
};

export async function addRepair(repairData: NewRepair) {
    const repairsCol = collection(db, 'repairs');
    const newDoc: Omit<Repair, 'id'> = {
        ...repairData,
        technician: repairData.technician || "No Asignado",
        status: "Cotización",
        entryDate: new Date().toISOString(),
        evaluation: "",
    }
    await addDoc(repairsCol, newDoc);
}

export async function getRepairs(): Promise<Repair[]> {
    const repairsCol = collection(db, 'repairs');
    const repairsSnapshot = await getDocs(repairsCol);
    const repairsList = repairsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Repair)).sort((a, b) => new Date(b.entryDate).getTime() - new Date(a.entryDate).getTime());
    return repairsList;
}

export async function getRepairById(id: string): Promise<Repair | null> {
    const repairDocRef = doc(db, 'repairs', id);
    const repairSnapshot = await getDoc(repairDocRef);

    if (repairSnapshot.exists()) {
        return { id: repairSnapshot.id, ...repairSnapshot.data() } as Repair;
    } else {
        return null;
    }
}


export async function seedRepairs(repairs: Repair[]) {
    const repairsCol = collection(db, 'repairs');
    const batch = writeBatch(db);
    
    repairs.forEach(repair => {
        const docRef = doc(repairsCol, repair.id);
        const { id, ...repairData } = repair;
        batch.set(docRef, repairData);
    });

    await batch.commit();
}
